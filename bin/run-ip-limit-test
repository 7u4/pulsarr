#!/usr/bin/env bash

function __is_crawl_loop_stopped {
  STOP=0
  if [ -e ".STOP" ] || [ -e ".KEEP_STOP" ]; then
   if [ -e ".STOP" ]; then
     mv .STOP ".STOP_EXECUTED_$(date +%Y%m%d.%H%M%S)"
   fi

    STOP=1
  fi

  (( $STOP == 1 )) && return 0 || return 1
}

bin=$(dirname "$0")
bin=$(cd "$bin">/dev/null || exit; pwd)

 # shellcheck source=bin/include/scent-config.sh
 . "$bin"/include/pulsar-config.sh
 # shellcheck source=bin/include/scent-common.sh
 . "$bin"/include/pulsar-common.sh

LIMIT=1000
# main loop : rounds of generate - fetch - parse - update
for ((round=1; round <= LIMIT ; round++))
do
  if ( __is_crawl_loop_stopped ); then
     echo "STOP file found - escaping loop"
     exit 0
  fi

  . "bin"/pulsar example sites.AmazonAccessKt
done
